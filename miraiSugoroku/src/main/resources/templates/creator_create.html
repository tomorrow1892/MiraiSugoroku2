<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>マス作成</title>
    <link rel="stylesheet" th:href="@{/css/display.css}">
    <script src="https://cdn.jsdelivr.net/gh/fengyuanchen/compressorjs/dist/compressor.min.js"></script>
    <link rel="stylesheet" href="/css/header.css">
    <!-- bootstrapを使用する際には下4行を追加 -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

    <!-- 背景設定用CSS   -->
    <style th:inline="text">
        body {
            background: url([[@{/img/baloon.png}]]);
            background-size: cover;
            background-attachment: fixed;
        }


    </style>

</head>

<body>
<!-- ヘッダー -->
<!--  マス作成画面へのリンクは未実装  -->
<nav class="navbar navbar-expand navbar-light fixed-top" style="background-color: #ceff85">
    <a class="navbar-brand" href="/">
        <img src="/img/logo.png" width="150" height="50" class="d-inline-block align-top" alt="">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation" style="width: auto; height: auto">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a th:href=@{/__${cid}__/config} class="nav-link">すごろくで遊ぶ</a>
            </li>
            <li class="nav-item">
                <a th:href=@{/__${cid}__/squares} class="nav-link">マス一覧</a>
            </li>
            <li class="nav-item">
                <a th:href=@{/__${cid}__/create} class="nav-link">マス作成</a>
            </li>
            <li class="nav-item">
                <a th:href=@{/__${cid}__/menu} class="nav-link">メニュー</a>
            </li>
        </ul>
    </div>
</nav>

<div class="title-center">
    <h1 class="sample_h_14">マス作成</h1>
</div>
<div class="discription">
   マスの作成画面です。<br>
    マスのタイトル、詳細説明、マスのイベント、マスを説明する画像を設定することができます。<br>
    作成したマスは、管理者の承認を得た後に公開されます。
</div>
    <div class="parent">
        <div>
            <form role="form" th:action="@{/{c}/create/confirm(c=${cid})}" th:object="${SquareForm}" method="post">
                <table>
                    <tr>
                        <td><label>タイトル: </label></td>
                        <td><input type="text" required th:field="*{title}" /></td>
                    </tr>
                    <tr>
                        <td><label>説明: </label></td>
                        <td><input type="text" required th:field="*{description}" /></td>
                    </tr>
                    <tr>
                        <td><label>マスイベント: </label></td>
                        <td>
                            <select required th:field="*{squareEventId}">

                                <option required th:each="se:${SquareEventList}" th:value="${se.squareEventID}"
                                    th:text="${se.eventTitle}" th:selected="${se.squareEventID == selectedValue}">
                                </option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label>画像: </label></td>
                        <td id="dragDropArea">
                            <div class="drag-drop-inside">
                                <p class="drag-drop-info">ここにファイルをドロップ</p>
                                <p>または</p>
                                <p class="drag-drop-buttons">
                                    <input id="fileInput" type="file" accept="image/*" value="ファイルを選択" name="photo"
                                        onChange="photoPreview(event)">
                                </p>
                                <div id="previewArea"></div>
                            </div>
                        </td>
                        <td><input type="text" th:field="*{picture}" id="pic" hidden /></td>
                    </tr>

                </table>
                <p style="text-align: center;"><input type="submit" value="確認" class="btn-submit" /></p>
            </form>

            <a th:href=@{/__${cid}__/menu}>メニューへ戻る</a>
        </div>
    </div>
</body>
<script>
    // window.addEventListener('DOMContentLoaded', function () {
    //     var img_element = document.createElement('img');
    //     var blob = document.createElement('text');

    //     // ファイルが選択されたら実行
    //     document.getElementById("upload_file").addEventListener('change', function (e) {

    //         var file_reader = new FileReader();

    //         file_reader.addEventListener('load', function (e) {

    //             // img要素を作成

    //             img_element.src = e.target.result;
    //             blob = e.target.result;


    //             // img要素をページに挿入
    //             var article_element = document.getElementById('content1');
    //             article_element.append(img_element);

    //             var blob_element = document.getElementById('pic');
    //             blob_element.append(blob);
    //             document.getElementById("pic").value = blob;

    //         });

    //         // ファイル内容をBase64にエンコードし、「data:〜」で始まるURL形式で取得
    //         file_reader.readAsDataURL(e.target.files[0]);
    //     });
    // });

    var fileArea = document.getElementById('dragDropArea');
    var fileInput = document.getElementById('fileInput');
    fileArea.addEventListener('dragover', function (evt) {
        evt.preventDefault();
        fileArea.classList.add('dragover');
    });
    fileArea.addEventListener('dragleave', function (evt) {
        evt.preventDefault();
        fileArea.classList.remove('dragover');
    });
    fileArea.addEventListener('drop', function (evt) {
        evt.preventDefault();
        fileArea.classList.remove('dragenter');
        var files = evt.dataTransfer.files;
        console.log("DRAG & DROP");
        console.table(files);
        fileInput.files = files;
        photoPreview('onChenge', files[0]);
    });
    function photoPreview(event, f = null) {
        var file = f;
        if (file === null) {
            file = event.target.files[0];
        }
        var reader = new FileReader();
        var preview = document.getElementById("previewArea");
        var previewImage = document.getElementById("previewImage");

        if (previewImage != null) {
            preview.removeChild(previewImage);
        }
        //画像ファイルを圧縮する
        const pressQuality = 0.8;
        const compressedImg = new Compressor(file, {
            quality: pressQuality,
            success(result) {
                var img = document.createElement("img");

                const reader = new FileReader()
                reader.onload = (event) => {
                    img.setAttribute("src", reader.result);
                    img.setAttribute("id", "previewImage");
                    img.setAttribute("width","300");//画像の幅を300に固定
                    preview.appendChild(img);
                    document.getElementById("pic").value = img.src;
                    console.log("圧縮率:"+pressQuality)
                    console.log(result)
                }
                reader.readAsDataURL(result)
            },
            maxWidth: 300,
            maxHeight: Infinity,
            mimeType: "auto",
            error(err) {
                console.log(file);
                console.log(err.message);
            }
        })
    }
</script>

</html>